/**
 * FLUXO CONVERSACIONAL V3 - ATUALIZADO CONFORME DOCUMENTO
 * Principais mudan√ßas:
 * ‚úÖ Captura de WhatsApp antecipada (logo ap√≥s nome)
 * ‚úÖ Op√ß√£o "Falar com a equipe" em todas as etapas ap√≥s captura inicial
 * ‚úÖ Handoff para atendimento humano (status ATENDIMENTO_HUMANO)
 * ‚úÖ Qualifica√ß√£o por ramo de atividade (n√£o mais por tamanho de rebanho)
 * ‚úÖ Sistema de scoring ajustado
 */

import { ConversationStep } from './conversationFlowV2';

export const conversationFlowV3: ConversationStep[] = [
  // ========================================
  // ETAPA 1: BOAS-VINDAS + CAPTURA DE NOME
  // ========================================
  {
    id: 'welcome',
    stage: 1,
    name: 'Boas-vindas',
    botMessage: 'Ol√°! Tudo bem? üòä\n\nSou o assistente virtual da {companyName}. √â um prazer ter voc√™ por aqui!\n\nAntes de falarmos sobre nossos produtos, como posso te chamar?',
    captureInput: {
      type: 'name',
      field: 'capturedName',
      nextStepId: 'capture_whatsapp',
    },
    actions: [{ type: 'increment_score', value: 10 }],
  },

  // ========================================
  // ETAPA 2: CAPTURA DE WHATSAPP (ANTECIPADA)
  // ========================================
  {
    id: 'capture_whatsapp',
    stage: 2,
    name: 'Captura WhatsApp',
    botMessage: 'Prazer em te conhecer, {nome}! üòä\n\nPara que eu possa deixar anotado aqui, qual o melhor n√∫mero de WhatsApp para entrarmos em contato?',
    captureInput: {
      type: 'phone',
      field: 'capturedPhone',
      validation: '^\\(?\\d{2}\\)?\\s?\\d{4,5}-?\\d{4}$',
      nextStepId: 'context_check',
    },
    actions: [{ type: 'increment_score', value: 30 }], // Pontua√ß√£o alta pois √© essencial
  },

  // ========================================
  // ETAPA 3: VERIFICA√á√ÉO DE CONTEXTO
  // ========================================
  {
    id: 'context_check',
    stage: 3,
    name: 'Verifica√ß√£o de Contexto',
    botMessage: 'Perfeito! Anotei aqui: {capturedPhone} ‚úÖ\n\nAgora me conta, {nome}, voc√™ trabalha com pecu√°ria?',
    options: [
      { id: 'opt1', label: 'üêÑ Sim, sou produtor rural', nextStepId: 'qualification_producer', captureAs: 'user_type' },
      { id: 'opt2', label: 'üëî Trabalho no setor agro', nextStepId: 'qualification_professional', captureAs: 'user_type' },
      { id: 'opt3', label: 'üîç Estou pesquisando pra algu√©m', nextStepId: 'qualification_proxy', captureAs: 'user_type' },
      { id: 'opt4', label: 'üí¨ S√≥ quero conhecer os produtos', nextStepId: 'initial_choice', captureAs: 'user_type' },
      { id: 'opt_human', label: 'üë§ Falar com a equipe', nextStepId: 'human_handoff', captureAs: 'wants_human' },
    ],
    actions: [{ type: 'increment_score', value: 10 }],
  },

  // ========================================
  // ETAPA 3.1: QUALIFICA√á√ÉO PRODUTOR (ATUALIZADO)
  // ========================================
  {
    id: 'qualification_producer',
    stage: 3,
    name: 'Qualifica√ß√£o Produtor',
    botMessage: 'Que legal, {nome}! Adoro conversar com quem est√° direto na lida. üë®‚Äçüåæ\n\nMe conta, qual o seu ramo de atividade?',
    options: [
      { id: 'opt1', label: 'ü•õ Pecu√°ria leiteira', nextStepId: 'initial_choice', captureAs: 'activity' },
      { id: 'opt2', label: 'ü•© Pecu√°ria de corte', nextStepId: 'initial_choice', captureAs: 'activity' },
      { id: 'opt3', label: 'üåæ Agricultura', nextStepId: 'initial_choice', captureAs: 'activity' },
      { id: 'opt4', label: 'üîÑ Outros', nextStepId: 'initial_choice', captureAs: 'activity' },
      { id: 'opt_human', label: 'üë§ Falar com a equipe', nextStepId: 'human_handoff', captureAs: 'wants_human' },
    ],
    actions: [{ type: 'increment_score', value: 10 }],
  },

  // ========================================
  // ETAPA 3.2: QUALIFICA√á√ÉO PROFISSIONAL
  // ========================================
  {
    id: 'qualification_professional',
    stage: 3,
    name: 'Qualifica√ß√£o Profissional',
    botMessage: 'Entendi, {nome}! Que bacana. üëî\n\nVoc√™ atua em qual √°rea especificamente?',
    options: [
      { id: 'opt1', label: 'ü©∫ Veterin√°rio/Zootecnista', nextStepId: 'initial_choice', captureAs: 'profession' },
      { id: 'opt2', label: 'üèóÔ∏è Engenheiro/Arquiteto Rural', nextStepId: 'initial_choice', captureAs: 'profession' },
      { id: 'opt3', label: 'üíº Consultor/Assessor T√©cnico', nextStepId: 'initial_choice', captureAs: 'profession' },
      { id: 'opt4', label: 'üè™ Trabalho com revenda', nextStepId: 'initial_choice', captureAs: 'profession' },
      { id: 'opt_human', label: 'üë§ Falar com a equipe', nextStepId: 'human_handoff', captureAs: 'wants_human' },
    ],
    actions: [{ type: 'increment_score', value: 15 }],
  },

  // ========================================
  // ETAPA 3.3: QUALIFICA√á√ÉO TERCEIROS
  // ========================================
  {
    id: 'qualification_proxy',
    stage: 3,
    name: 'Qualifica√ß√£o Terceiros',
    botMessage: 'Ah, que legal voc√™ estar ajudando! üòä\n\n√â pra um familiar, amigo ou cliente?',
    options: [
      { id: 'opt1', label: 'üë®‚Äçüë©‚Äçüëß √â pra fam√≠lia', nextStepId: 'initial_choice', captureAs: 'proxy_relation' },
      { id: 'opt2', label: 'üë• Pra um amigo', nextStepId: 'initial_choice', captureAs: 'proxy_relation' },
      { id: 'opt3', label: 'üíº Pra um cliente', nextStepId: 'initial_choice', captureAs: 'proxy_relation' },
      { id: 'opt_human', label: 'üë§ Falar com a equipe', nextStepId: 'human_handoff', captureAs: 'wants_human' },
    ],
    actions: [{ type: 'increment_score', value: 10 }],
  },

  // ========================================
  // ETAPA 4: ESCOLHA INICIAL
  // ========================================
  {
    id: 'initial_choice',
    stage: 4,
    name: 'Escolha Inicial',
    botMessage: 'Beleza, {nome}! Agora me diz, o que te traz aqui hoje? Como posso te ajudar?',
    options: [
      { id: 'opt1', label: 'üõçÔ∏è Quero conhecer os produtos', nextStepId: 'show_products', captureAs: 'initial_choice' },
      { id: 'opt2', label: 'üí∞ Preciso de um or√ßamento', nextStepId: 'budget_question', captureAs: 'initial_choice' },
      { id: 'opt3', label: '‚ùì Tenho uma d√∫vida', nextStepId: 'faq_question', captureAs: 'initial_choice' },
      { id: 'opt_human', label: 'üë§ Falar com a equipe', nextStepId: 'human_handoff', captureAs: 'wants_human' },
    ],
    actions: [{ type: 'increment_score', value: 5 }],
  },

  // ========================================
  // ETAPA 4.1: PERGUNTA SOBRE OR√áAMENTO
  // ========================================
  {
    id: 'budget_question',
    stage: 4,
    name: 'Quest√£o de Or√ßamento',
    botMessage: 'Opa, bacana! Vou te ajudar com isso. üí∞\n\nVoc√™ j√° sabe qual produto precisa ou quer que eu te mostre as op√ß√µes primeiro?',
    options: [
      { id: 'opt1', label: '‚úÖ J√° sei o que quero', nextStepId: 'show_products', captureAs: 'knows_product' },
      { id: 'opt2', label: 'ü§î Me mostra as op√ß√µes', nextStepId: 'show_products', captureAs: 'exploring' },
      { id: 'opt_human', label: 'üë§ Falar com a equipe', nextStepId: 'human_handoff', captureAs: 'wants_human' },
    ],
    actions: [{ type: 'increment_score', value: 20 }],
  },

  // ========================================
  // ETAPA 5: APRESENTA√á√ÉO DE PRODUTOS (Din√¢mica)
  // ========================================
  {
    id: 'show_products',
    stage: 5,
    name: 'Lista de Produtos',
    botMessage: 'Olha s√≥, {nome}! Esses s√£o os nossos principais produtos:\n\n{productList}\n\nQuer que eu te mostre mais sobre qual deles?',
    options: [
      // OP√á√ïES DIN√ÇMICAS ser√£o inseridas aqui pelo service
      // Formato: { id: 'prod_X', label: 'üì¶ Nome Real', nextStepId: 'product_details', captureAs: 'selected_product' }
      { id: 'opt_faq', label: '‚ùì Tenho uma d√∫vida antes', nextStepId: 'faq_question', captureAs: 'has_question' },
      { id: 'opt_human', label: 'üë§ Falar com a equipe', nextStepId: 'human_handoff', captureAs: 'wants_human' },
    ],
    actions: [{ type: 'increment_score', value: 10 }],
  },

  // ========================================
  // ETAPA 5.5: INTERESSE NO PRODUTO (NOVO - Intermedi√°rio Inteligente)
  // ========================================
  {
    id: 'product_interest',
    stage: 5,
    name: 'Interesse no Produto',
    botMessage: '√ìtima escolha, {nome}! üòä\n\nVou solicitar √† nossa equipe que entre em contato com voc√™ para enviar mais informa√ß√µes sobre:\n\n{selectedProductsList}\n\nEles v√£o te mandar todos os detalhes, especifica√ß√µes t√©cnicas e valores diretamente no WhatsApp {capturedPhone}. üì±\n\nQuer adicionar mais algum produto de interesse?',
    options: [
      { id: 'opt1', label: '‚úÖ Sim, quero ver mais produtos', nextStepId: 'show_products', captureAs: 'explore_more' },
      { id: 'opt2', label: 'üí¨ N√£o, pode prosseguir', nextStepId: 'product_interest_confirm', captureAs: 'single_product' },
      { id: 'opt_human', label: 'üë§ Falar com a equipe agora', nextStepId: 'human_handoff', captureAs: 'wants_human' },
    ],
    actions: [{ type: 'increment_score', value: 15 }],
  },

  // ========================================
  // ETAPA 5.6: CONFIRMA√á√ÉO DE INTERESSE (NOVO)
  // ========================================
  {
    id: 'product_interest_confirm',
    stage: 5,
    name: 'Confirma√ß√£o de Interesse',
    botMessage: 'Perfeito! Nossa equipe vai entrar em contato em breve com todas as informa√ß√µes sobre os produtos que voc√™ selecionou. ü§ù\n\nPosso te avisar quando houver promo√ß√µes?',
    options: [
      { id: 'opt1', label: '‚úÖ Pode avisar sim', nextStepId: 'closing_with_lead', captureAs: 'marketing_opt_in' },
      { id: 'opt2', label: '‚ùå N√£o precisa, obrigado', nextStepId: 'closing_with_lead', captureAs: 'marketing_opt_out' },
    ],
    actions: [
      { type: 'create_lead' },
      { type: 'send_notification' },
    ],
  },

  // ========================================
  // ETAPA 6: DETALHES DO PRODUTO (Dados Reais)
  // ========================================
  {
    id: 'product_details',
    stage: 6,
    name: 'Detalhes do Produto',
    botMessage: 'Show de bola, {nome}! Esse √© um produto excelente. üòä\n\n{productDetails}\n\n‚ú® Principais benef√≠cios:\n{productBenefits}\n\nüí° Ah, e se voc√™ se interessar, tamb√©m temos:\n{relatedProducts}\n\nQue tal agora?',
    options: [
      { id: 'opt1', label: 'üí∞ Quero saber os valores', nextStepId: 'pricing_urgency', captureAs: 'wants_pricing' },
      { id: 'opt2', label: 'üì± Me manda mais info no WhatsApp', nextStepId: 'confirm_material_send', captureAs: 'wants_material' },
      { id: 'opt3', label: '‚ùì Tenho uma pergunta', nextStepId: 'product_question', captureAs: 'has_question' },
      { id: 'opt4', label: 'üîÑ Ver outros produtos', nextStepId: 'show_products', captureAs: 'explore_more' },
      { id: 'opt_human', label: 'üë§ Falar com a equipe', nextStepId: 'human_handoff', captureAs: 'wants_human' },
    ],
    actions: [{ type: 'increment_score', value: 15 }],
  },

  // ========================================
  // ETAPA 6.1: URG√äNCIA DE PRE√áO
  // ========================================
  {
    id: 'pricing_urgency',
    stage: 6,
    name: 'Urg√™ncia de Pre√ßo',
    botMessage: 'Tranquilo! Vou te passar as informa√ß√µes de pre√ßo. üí∞\n\nS√≥ me diz uma coisa: √© pra quando?',
    options: [
      { id: 'opt1', label: 'üî• Preciso urgente (15 dias)', nextStepId: 'handoff_confirmation', captureAs: 'urgency' },
      { id: 'opt2', label: 'üìÖ Pra 1 ou 2 meses', nextStepId: 'handoff_confirmation', captureAs: 'urgency' },
      { id: 'opt3', label: 'üìÜ Mais de 3 meses (planejando)', nextStepId: 'handoff_confirmation', captureAs: 'urgency' },
      { id: 'opt4', label: 'ü§î Ainda n√£o tenho prazo', nextStepId: 'handoff_confirmation', captureAs: 'urgency' },
    ],
    actions: [{ type: 'increment_score', value: 25 }],
  },

  // ========================================
  // ETAPA 6.2: CONFIRMA√á√ÉO DE ENVIO (Material WhatsApp)
  // ========================================
  {
    id: 'confirm_material_send',
    stage: 6,
    name: 'Confirma√ß√£o de Envio',
    botMessage: 'Perfeito, {nome}! Vou enviar todo o material sobre {interesse} no n√∫mero {capturedPhone}. üì±',
    options: [
      { id: 'opt1', label: '‚úÖ Obrigado, aguardo!', nextStepId: 'marketing_consent', captureAs: 'confirmed_material' },
      { id: 'opt2', label: 'üîÑ Ver outros produtos', nextStepId: 'show_products', captureAs: 'explore_more' },
    ],
    actions: [{ type: 'increment_score', value: 10 }],
  },

  // ========================================
  // ETAPA 6.3: PERGUNTA SOBRE PRODUTO
  // ========================================
  {
    id: 'product_question',
    stage: 6,
    name: 'D√∫vida Espec√≠fica',
    botMessage: 'Claro, {nome}! Fica √† vontade pra perguntar. üòä\n\nQual sua d√∫vida sobre {interesse}?',
    captureInput: {
      type: 'text',
      field: 'specific_question',
      nextStepId: 'after_product_question',
    },
    actions: [{ type: 'increment_score', value: 10 }],
  },

  {
    id: 'after_product_question',
    stage: 6,
    name: 'Ap√≥s Responder D√∫vida',
    botMessage: 'Espero ter te ajudado! üòä\n\nMas olha, pra quest√µes mais t√©cnicas, o ideal √© falar com um dos nossos especialistas. Eles v√£o conseguir te explicar direitinho todos os detalhes.',
    options: [
      { id: 'opt1', label: '‚úÖ Respondeu minha d√∫vida', nextStepId: 'product_next_action', captureAs: 'question_answered' },
      { id: 'opt2', label: 'üë§ Falar com a equipe', nextStepId: 'human_handoff', captureAs: 'wants_human' },
      { id: 'opt3', label: 'üîÑ Ver outros produtos', nextStepId: 'show_products', captureAs: 'explore_more' },
    ],
  },

  {
    id: 'product_next_action',
    stage: 6,
    name: 'Pr√≥xima A√ß√£o ap√≥s D√∫vida',
    botMessage: 'Que bom! E agora, o que voc√™ gostaria de fazer?',
    options: [
      { id: 'opt1', label: 'üí∞ Quero saber os valores', nextStepId: 'pricing_urgency', captureAs: 'wants_pricing' },
      { id: 'opt2', label: 'üì± Me manda mais info', nextStepId: 'confirm_material_send', captureAs: 'wants_material' },
      { id: 'opt3', label: 'üîÑ Ver outros produtos', nextStepId: 'show_products', captureAs: 'explore_more' },
      { id: 'opt_human', label: 'üë§ Falar com a equipe', nextStepId: 'human_handoff', captureAs: 'wants_human' },
    ],
  },

  // ========================================
  // ETAPA 7: CONFIRMA√á√ÉO DE HANDOFF
  // ========================================
  {
    id: 'handoff_confirmation',
    stage: 7,
    name: 'Confirma√ß√£o de Transfer√™ncia',
    botMessage: 'Perfeito, {nome}! Nosso time vai entrar em contato com voc√™ no n√∫mero {capturedPhone} em breve. ü§ù\n\nPosso te avisar quando houver promo√ß√µes sobre {interesse}?',
    options: [
      { id: 'opt1', label: '‚úÖ Pode avisar sim', nextStepId: 'closing_with_lead', captureAs: 'marketing_opt_in' },
      { id: 'opt2', label: '‚ùå N√£o precisa, obrigado', nextStepId: 'closing_with_lead', captureAs: 'marketing_opt_out' },
    ],
    actions: [
      { type: 'create_lead' },
      { type: 'send_notification' },
    ],
  },

  // ========================================
  // ETAPA 8: CONSENTIMENTO DE MARKETING
  // ========================================
  {
    id: 'marketing_consent',
    stage: 8,
    name: 'Consentimento Marketing',
    botMessage: 'Show! Vou mandar tudo direitinho no {capturedPhone}. üì±\n\nPosso te avisar quando houver novidades sobre {interesse}?',
    options: [
      { id: 'opt1', label: '‚úÖ Pode sim!', nextStepId: 'closing', captureAs: 'marketing_opt_in' },
      { id: 'opt2', label: '‚ùå N√£o precisa, valeu', nextStepId: 'closing', captureAs: 'marketing_opt_out' },
    ],
    actions: [
      { type: 'create_lead' },
      { type: 'send_notification' },
    ],
  },

  // ========================================
  // ETAPA 9: CONTINUAR NAVEGANDO
  // ========================================
  {
    id: 'continue_browsing',
    stage: 9,
    name: 'Continuar Navegando',
    botMessage: 'Tranquilo, {nome}! Sem press√£o. üòä\n\nQuer continuar explorando nossos produtos?',
    options: [
      { id: 'opt1', label: 'üîÑ Quero ver mais produtos', nextStepId: 'show_products', captureAs: 'explore_more' },
      { id: 'opt2', label: '‚ùì Tenho uma d√∫vida', nextStepId: 'faq_question', captureAs: 'has_question' },
      { id: 'opt3', label: 'üëã Vou ficando por aqui', nextStepId: 'closing_simple', captureAs: 'end_chat' },
      { id: 'opt_human', label: 'üë§ Falar com a equipe', nextStepId: 'human_handoff', captureAs: 'wants_human' },
    ],
    actions: [
      { type: 'create_lead' },
    ],
  },

  // ========================================
  // ETAPA 10: FAQ INTELIGENTE
  // ========================================
  {
    id: 'faq_question',
    stage: 10,
    name: 'Pergunta FAQ',
    botMessage: 'Claro, {nome}! Pode mandar sua d√∫vida que eu vou te ajudar. üòÑ\n\nFica √† vontade pra perguntar qualquer coisa!',
    captureInput: {
      type: 'text',
      field: 'faq_question',
      nextStepId: 'faq_response',
    },
  },

  {
    id: 'faq_response',
    stage: 10,
    name: 'Resposta FAQ',
    botMessage: '{faqAnswer}\n\n---\n\nConsegui te ajudar, {nome}? Ficou claro? üòä',
    options: [
      { id: 'opt1', label: '‚úÖ Sim, obrigado!', nextStepId: 'post_faq_action', captureAs: 'faq_helpful' },
      { id: 'opt2', label: '‚ùì Tenho outra d√∫vida', nextStepId: 'faq_question', captureAs: 'another_question' },
      { id: 'opt_human', label: 'üë§ Falar com a equipe', nextStepId: 'human_handoff', captureAs: 'wants_human' },
    ],
  },

  {
    id: 'post_faq_action',
    stage: 10,
    name: 'P√≥s-FAQ',
    botMessage: 'Fico feliz em ter ajudado! üòä\n\nQuer ver os produtos ou prefere deixar pra depois?',
    options: [
      { id: 'opt1', label: 'üõçÔ∏è Quero ver os produtos', nextStepId: 'show_products', captureAs: 'explore_products' },
      { id: 'opt2', label: 'üëã Vou ficando por aqui', nextStepId: 'closing_simple', captureAs: 'end_chat' },
      { id: 'opt_human', label: 'üë§ Falar com a equipe', nextStepId: 'human_handoff', captureAs: 'wants_human' },
    ],
  },

  // ========================================
  // ETAPA 11: HANDOFF HUMANO (NOVO) ‚≠ê
  // ========================================
  {
    id: 'human_handoff',
    stage: 11,
    name: 'Handoff Humano',
    botMessage: 'Perfeito, {nome}! Vou te conectar com nossa equipe de atendimento. üë®‚Äçüíº\n\nVoc√™ ser√° atendido por um especialista em breve via WhatsApp no n√∫mero {capturedPhone}.\n\nPronto! Nossa equipe vai te chamar no WhatsApp em instantes.\n\nFique de olho nas mensagens! üì±',
    options: [], // Sem op√ß√µes - encerra conversa
    actions: [
      { type: 'create_lead' }, // Cria lead com status ATENDIMENTO_HUMANO
      { type: 'send_notification' }, // Notifica equipe
    ],
  },

  // ========================================
  // ETAPA 12: ENCERRAMENTOS
  // ========================================
  {
    id: 'closing_with_lead',
    stage: 12,
    name: 'Encerramento com Lead',
    botMessage: 'Valeu demais, {nome}! üôå\n\nO pessoal aqui do time vai entrar em contato com voc√™ em breve, t√°?\n\nSe quiser dar mais uma olhada nos produtos enquanto isso, fique √† vontade!',
    options: [
      { id: 'opt1', label: 'üîÑ Quero ver mais produtos', nextStepId: 'show_products', captureAs: 'explore_more' },
      { id: 'opt2', label: 'üëã T√° bom, at√© logo!', nextStepId: 'closing_final', captureAs: 'end_chat' },
    ],
  },

  {
    id: 'closing',
    stage: 12,
    name: 'Encerramento Padr√£o',
    botMessage: 'Fechou ent√£o, {nome}! Valeu demais pelo seu tempo! üôè\n\nVou mandar tudo certinho pro seu WhatsApp, pode deixar!\n\nQualquer coisa que precisar, √© s√≥ dar um toque:\n\nüìû {companyPhone}\nüìç {companyAddress}',
    options: [
      { id: 'opt1', label: 'üîÑ Ver mais produtos', nextStepId: 'show_products', captureAs: 'explore_more' },
      { id: 'opt2', label: 'üëã J√° √© o suficiente!', nextStepId: 'closing_final', captureAs: 'end_chat' },
    ],
  },

  {
    id: 'closing_simple',
    stage: 12,
    name: 'Encerramento Simples',
    botMessage: 'Valeu, {nome}! üòä\n\nFoi um prazer conversar com voc√™! Qualquer coisa que precisar, √© s√≥ aparecer por aqui de novo! üëã\n\nüìû {companyPhone}\nüåê {companyWebsite}',
    options: [],
  },

  {
    id: 'closing_final',
    stage: 12,
    name: 'Encerramento Final',
    botMessage: 'Foi √≥timo te atender, {nome}! üòä\n\nQualquer coisa que precisar, voc√™ j√° sabe onde me encontrar!\n\nAt√© a pr√≥xima! üëã\n\n---\nüìû {companyPhone}\nüìç {companyAddress}\nüåê {companyWebsite}\n‚è∞ {workingHours}',
    options: [],
  },
];

/**
 * Calcula score de qualifica√ß√£o V3 - ATUALIZADO CONFORME DOCUMENTO
 */
export function calculateQualificationScoreV3(session: any, messageCount: number = 0): number {
  let score = 0;

  // ========================================
  // 1. DADOS B√ÅSICOS (50 pontos m√°ximo)
  // ========================================
  if (session.capturedName) score += 10;
  if (session.capturedPhone) score += 30; // ‚≠ê Aumentado de 25 para 30 (captura antecipada)
  if (session.capturedEmail) score += 10; // Reduzido de 15 para 10

  // ========================================
  // 2. ENGAJAMENTO (30 pontos m√°ximo)
  // ========================================
  if (messageCount >= 5) score += 10;
  if (messageCount >= 10) score += 5;
  if (messageCount >= 15) score += 5;

  if (session.startedAt) {
    const now = session.endedAt || new Date();
    const timeSpent = (now.getTime() - new Date(session.startedAt).getTime()) / 1000;
    if (timeSpent > 120) score += 10; // Mais de 2 minutos
  }

  // ========================================
  // 3. INTERESSE E INTEN√á√ÉO (40 pontos m√°ximo)
  // ========================================
  if (session.interest) score += 10;

  const responses = JSON.parse(session.userResponses || '{}');

  // Passou por qualifica√ß√£o
  if (responses.user_type) score += 10;

  // Profundidade no funil (est√°gio alcan√ßado)
  if (session.currentStage >= 5) score += 5; // Viu produtos
  if (session.currentStage >= 6) score += 10; // Viu detalhes
  if (session.currentStage >= 11) score += 5; // Chegou no handoff

  // ========================================
  // 4. QUALIFICADORES ESPECIAIS (at√© 30 pontos extras)
  // ========================================

  // Sinais de alta inten√ß√£o
  if (responses.wants_pricing) score += 15; // Perguntou pre√ßo
  if (responses.wants_material) score += 10; // Pediu material
  if (responses.initial_choice === 'üí∞ Preciso de um or√ßamento') score += 15;

  // Qualifica√ß√£o de contexto - Produtor rural
  if (responses.user_type === 'üêÑ Sim, sou produtor rural') score += 10;

  // Ramo de atividade
  if (responses.activity === 'ü•õ Pecu√°ria leiteira') score += 10;
  if (responses.activity === 'ü•© Pecu√°ria de corte') score += 8;
  if (responses.activity === 'üåæ Agricultura') score += 5;

  // Qualifica√ß√£o de contexto - Profissional
  if (responses.user_type === 'üëî Trabalho no setor agro') score += 15;
  if (responses.profession?.includes('Veterin√°rio') || responses.profession?.includes('Consultor')) score += 15;

  // Urg√™ncia
  if (responses.urgency === 'üî• Preciso urgente (15 dias)') score += 20; // ‚≠ê Muito quente
  if (responses.urgency === 'üìÖ Pra 1 ou 2 meses') score += 12;
  if (responses.urgency === 'üìÜ Mais de 3 meses (planejando)') score += 5;
  if (responses.urgency === 'ü§î Ainda n√£o tenho prazo') score += 2;

  // Marketing opt-in
  if (session.marketingOptIn) score += 5;

  // N√£o deixar passar de 100
  return Math.min(score, 100);
}

/**
 * Busca FAQ por similaridade simples (fuzzy match)
 */
export function findBestFAQ(userQuestion: string, faqs: any[]): any | null {
  if (!faqs || faqs.length === 0) return null;

  const normalizedQuestion = userQuestion.toLowerCase().trim();

  const scores = faqs.map(faq => {
    const normalizedFAQ = faq.question.toLowerCase();
    let score = 0;

    // Match exato
    if (normalizedFAQ.includes(normalizedQuestion)) {
      score += 100;
    }

    // Match de palavras individuais
    const userWords = normalizedQuestion.split(/\s+/).filter(w => w.length > 3);
    const faqWords = normalizedFAQ.split(/\s+/);

    userWords.forEach(word => {
      if (faqWords.some(fw => fw.includes(word) || word.includes(fw))) {
        score += 20;
      }
    });

    return { faq, score };
  });

  const best = scores.sort((a, b) => b.score - a.score)[0];

  // Threshold m√≠nimo de 40 pontos
  return best.score >= 40 ? best.faq : null;
}

/**
 * Recomenda produtos relacionados
 */
export function recommendRelatedProducts(
  selectedProductName: string,
  allProducts: any[],
  limit: number = 2
): any[] {
  if (!allProducts || allProducts.length <= 1) return [];

  const otherProducts = allProducts.filter(p => p.name !== selectedProductName);
  return otherProducts.slice(0, limit);
}
