name: ğŸš€ Deploy Ferraco CRM - Full Stack

# Deploy automÃ¡tico do Ferraco CRM (Container Ãšnico - Frontend + Backend + Nginx)

concurrency:
  group: ferraco-deploy-vps
  cancel-in-progress: true

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '72.60.10.108'
  VPS_USER: 'root'
  APP_DIR: '/root/ferraco-crm'
  APP_PORT: '3050'
  COMPOSE_PROJECT: 'ferraco'
  DOMAIN: 'painelcheckar.com.br'

jobs:
  deploy:
    name: ğŸš€ Deploy Full Stack para VPS
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ”‘ Setup SSH Tools
      run: |
        echo "ğŸ”‘ Instalando ferramentas SSH..."
        sudo apt-get update -q
        sudo apt-get install -y sshpass
        echo "âœ… Ferramentas SSH instaladas"

    - name: ğŸ” Pre-Deploy Validation
      run: |
        echo "ğŸ” Validando estrutura do projeto FERRACO CRM..."
        echo "ğŸ“‹ Arquitetura: Container Ãšnico (Frontend + Backend + Nginx)"
        echo ""
        echo "ğŸ“¦ Arquivos essenciais:"
        ls -la Dockerfile docker-compose.vps.yml || { echo "âŒ Docker files faltando!"; exit 1; }
        ls -la docker/nginx.conf docker/startup.sh || { echo "âŒ Nginx/startup faltando!"; exit 1; }
        echo ""
        echo "ğŸ“‹ Frontend (React):"
        ls -la package.json vite.config.ts src/components/ src/pages/ || { echo "âŒ Frontend incompleto!"; exit 1; }
        echo ""
        echo "ğŸ“‹ Backend (Node.js):"
        ls -la ferraco-backend/package.json ferraco-backend/src/ ferraco-backend/prisma/ || { echo "âŒ Backend incompleto!"; exit 1; }
        echo ""
        echo "âœ… Estrutura validada com sucesso!"

    - name: ğŸ“¦ Prepare Deployment Package
      run: |
        echo "ğŸ“¦ Preparando pacote FERRACO CRM FULL STACK..."
        echo "  ğŸ“¦ Commit: ${{ github.sha }}"
        echo "  ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "  ğŸ‘¤ Actor: ${{ github.actor }}"
        echo "  ğŸ• Timestamp: $(date -u)"
        echo ""

        # Criar pacote compacto
        tar --warning=no-file-changed -czf deploy.tar.gz \
          --exclude='.git' \
          --exclude='**/node_modules' \
          --exclude='**/dist' \
          --exclude='**/build' \
          --exclude='*.log' \
          --exclude='coverage' \
          --exclude='.env.local' \
          --exclude='.env' \
          --exclude='**/.DS_Store' \
          --exclude='**/Thumbs.db' \
          . || true

        echo ""
        echo "ğŸ“Š Tamanho do pacote:"
        ls -lh deploy.tar.gz
        echo "âœ… Pacote criado com sucesso!"

    - name: ğŸ“¤ Upload to VPS
      run: |
        echo "ğŸ“¤ Enviando pacote para VPS..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' scp \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          -o ConnectTimeout=30 \
          deploy.tar.gz ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/tmp/
        echo "âœ… Upload concluÃ­do!"

    - name: ğŸš€ Deploy on VPS
      run: |
        echo "ğŸš€ Iniciando deploy na VPS..."

        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          -o ServerAliveInterval=30 \
          -o ServerAliveCountMax=3 \
          -o ConnectTimeout=30 \
          ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << "DEPLOY_SCRIPT"
          set -e

          echo "========================================="
          echo "ğŸš€ FERRACO CRM - Deploy Full Stack"
          echo "========================================="
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo "ğŸ• Timestamp: $(date)"
          echo "ğŸ¯ Arquitetura: Container Ãšnico"
          echo "ğŸ³ Porta VPS: ${{ env.APP_PORT }}"
          echo "========================================="
          echo ""

          # Configurar sistema
          echo "ğŸ“¦ Atualizando sistema..."
          export DEBIAN_FRONTEND=noninteractive
          apt-get update -qq
          apt-get install -y curl wget ca-certificates lsb-release >/dev/null 2>&1

          # Instalar/Atualizar Docker
          echo "ğŸ³ Configurando Docker..."
          if ! command -v docker &> /dev/null; then
            echo "Instalando Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh >/dev/null 2>&1
            rm get-docker.sh
            systemctl start docker
            systemctl enable docker
          fi
          docker --version

          # Verificar Docker Compose v2 (PROBLEMA #8)
          if ! docker compose version &> /dev/null; then
            echo "Instalando Docker Compose v2..."
            apt-get update -qq
            apt-get install -y docker-compose-plugin >/dev/null 2>&1
          fi
          docker compose version

          # Parar containers anteriores
          echo "â¹ï¸  Parando containers anteriores..."
          cd ${{ env.APP_DIR }} 2>/dev/null || true
          docker compose -f docker-compose.vps.yml -p ${{ env.COMPOSE_PROJECT }} down --volumes --remove-orphans 2>/dev/null || true

          # Remover container se ainda existir
          docker rm -f ferraco-crm-vps 2>/dev/null || true

          # Liberar porta
          echo "ğŸ”“ Liberando porta ${{ env.APP_PORT }}..."
          fuser -k ${{ env.APP_PORT }}/tcp 2>/dev/null || true
          sleep 2

          # Limpar imagens antigas do Ferraco (FORÃ‡AR REBUILD COMPLETO)
          echo "ğŸ§¹ Limpando imagens antigas e cache..."
          docker images --filter "reference=*ferraco*" -q | xargs -r docker rmi -f 2>/dev/null || true
          docker builder prune -f 2>/dev/null || true
          docker system prune -f 2>/dev/null || true

          # Backup e preparaÃ§Ã£o
          if [ -d "${{ env.APP_DIR }}" ]; then
            echo "ğŸ’¾ Fazendo backup..."
            BACKUP_DIR="${{ env.APP_DIR }}.backup.$(date +%Y%m%d-%H%M%S)"
            mv ${{ env.APP_DIR }} $BACKUP_DIR 2>/dev/null || true
            # Manter apenas Ãºltimos 3 backups
            ls -dt ${{ env.APP_DIR }}.backup.* 2>/dev/null | tail -n +4 | xargs -r rm -rf
          fi

          # Extrair cÃ³digo
          echo "ğŸ“ Extraindo aplicaÃ§Ã£o..."
          mkdir -p ${{ env.APP_DIR }}
          cd ${{ env.APP_DIR }}
          tar -xzf /tmp/deploy.tar.gz
          rm -f /tmp/deploy.tar.gz

          # Validar estrutura
          echo "ğŸ” Validando estrutura..."
          [ -f "Dockerfile" ] || { echo "âŒ Dockerfile nÃ£o encontrado!"; exit 1; }
          [ -f "docker-compose.vps.yml" ] || { echo "âŒ docker-compose.vps.yml nÃ£o encontrado!"; exit 1; }
          [ -d "docker" ] || { echo "âŒ Pasta docker nÃ£o encontrada!"; exit 1; }
          [ -f "docker/startup.sh" ] || { echo "âŒ docker/startup.sh nÃ£o encontrado!"; exit 1; }
          [ -f "docker/nginx.conf" ] || { echo "âŒ docker/nginx.conf nÃ£o encontrado!"; exit 1; }
          [ -d "ferraco-backend" ] || { echo "âŒ Backend nÃ£o encontrado!"; exit 1; }
          [ -d "src" ] || { echo "âŒ Frontend nÃ£o encontrado!"; exit 1; }

          # Corrigir permissÃµes dos scripts (PROBLEMA #5)
          echo "ğŸ”§ Corrigindo permissÃµes dos scripts..."
          chmod +x docker/startup.sh docker/setup-ssl.sh 2>/dev/null || true

          # Debug: listar conteÃºdo da pasta docker
          echo "ğŸ“‹ ConteÃºdo da pasta docker:"
          ls -la docker/

          echo "âœ… Estrutura validada!"

          # Criar diretÃ³rios de dados
          echo "ğŸ—„ï¸  Preparando diretÃ³rios de dados..."
          mkdir -p ferraco-backend/data ferraco-backend/logs
          chmod 777 ferraco-backend/data ferraco-backend/logs

          # Configurar variÃ¡veis de ambiente
          echo "âš™ï¸  Configurando ambiente..."
          export BUILD_TIMESTAMP=$(date +%s)
          export JWT_SECRET="ferraco-vps-jwt-${{ github.sha }}"
          export CORS_ORIGIN="http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}"

          # Build da imagem
          echo "ğŸ—ï¸  Building imagem Docker (isso pode levar alguns minutos)..."
          DOCKER_BUILDKIT=1 docker compose -f docker-compose.vps.yml -p ${{ env.COMPOSE_PROJECT }} build \
            --no-cache \
            --pull \
            --build-arg BUILD_TIMESTAMP=$BUILD_TIMESTAMP

          # Iniciar aplicaÃ§Ã£o
          echo "ğŸš€ Iniciando aplicaÃ§Ã£o..."
          docker compose -f docker-compose.vps.yml -p ${{ env.COMPOSE_PROJECT }} up -d

          # Aguardar inicializaÃ§Ã£o
          echo "â³ Aguardando aplicaÃ§Ã£o inicializar (45 segundos)..."
          sleep 45

          # Verificar containers
          echo "ğŸ” Verificando containers..."
          docker compose -f docker-compose.vps.yml -p ${{ env.COMPOSE_PROJECT }} ps

          # Health check
          echo "ğŸ©º Executando health check..."
          MAX_TRIES=15
          for i in $(seq 1 $MAX_TRIES); do
            if curl -f -s http://localhost:${{ env.APP_PORT }}/health >/dev/null 2>&1; then
              echo "âœ… Frontend health check OK!"
              FRONTEND_OK=true
              break
            fi
            echo "  Tentativa $i/$MAX_TRIES - aguardando..."
            sleep 5
          done

          for i in $(seq 1 $MAX_TRIES); do
            if curl -f -s http://localhost:${{ env.APP_PORT }}/api/health >/dev/null 2>&1; then
              echo "âœ… Backend API health check OK!"
              BACKEND_OK=true
              break
            fi
            echo "  Tentativa $i/$MAX_TRIES - aguardando..."
            sleep 5
          done

          # VerificaÃ§Ã£o final
          if [ "$FRONTEND_OK" = true ] && [ "$BACKEND_OK" = true ]; then
            echo ""
            echo "========================================="
            echo "âœ… DEPLOY CONCLUÃDO COM SUCESSO!"
            echo "========================================="
            echo "ğŸŒ Frontend: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}"
            echo "ğŸ”Œ Backend API: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/api"
            echo "ğŸ©º Health: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/health"
            echo "ğŸ‘¨â€ğŸ’¼ Admin: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/admin"
            echo "========================================="
          else
            echo ""
            echo "âŒ FALHA NO DEPLOY - Health checks falharam!"
            echo "ğŸ“‹ Logs dos containers:"
            docker compose -f docker-compose.vps.yml -p ${{ env.COMPOSE_PROJECT }} logs --tail 50
            exit 1
          fi
        DEPLOY_SCRIPT

    - name: ğŸ‰ Deploy Success
      run: |
        echo ""
        echo "========================================="
        echo "ğŸ‰ FERRACO CRM DEPLOYADO COM SUCESSO!"
        echo "========================================="
        echo ""
        echo "ğŸ“¦ InformaÃ§Ãµes do Deploy:"
        echo "  ğŸ·ï¸  VersÃ£o: 2.0.0"
        echo "  ğŸ“¦ Commit: ${{ github.sha }}"
        echo "  ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "  ğŸ‘¤ Autor: ${{ github.actor }}"
        echo "  ğŸ• Data: $(date)"
        echo ""
        echo "ğŸ”— Links de Acesso:"
        echo "  ğŸŒ AplicaÃ§Ã£o: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}"
        echo "  ğŸ”Œ API: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/api"
        echo "  ğŸ©º Health: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/health"
        echo "  ğŸ‘¨â€ğŸ’¼ Admin: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/admin"
        echo ""
        echo "ğŸ—ï¸  Stack TecnolÃ³gica:"
        echo "  ğŸ¯ Backend: Node.js + Express + Prisma + SQLite"
        echo "  ğŸ¨ Frontend: React + Vite + TypeScript + Tailwind"
        echo "  ğŸŒ Proxy: Nginx"
        echo "  ğŸ³ Deploy: Docker (Container Ãšnico)"
        echo "  ğŸ” Auth: JWT + Bcrypt"
        echo ""
        echo "âœ… Sistema pronto para uso!"
        echo "========================================="
