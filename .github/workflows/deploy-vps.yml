name: üöÄ Deploy Ferraco CRM - Full Stack

# Deploy autom√°tico do Ferraco CRM (Container √önico - Frontend + Backend + Nginx)

concurrency:
  group: ferraco-deploy-vps
  cancel-in-progress: true

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '72.60.10.108'
  VPS_USER: 'root'
  APP_DIR: '/root/ferraco-crm'
  APP_PORT: '3050'
  COMPOSE_PROJECT: 'ferraco'
  DOMAIN: 'metalurgicaferraco.com'

jobs:
  deploy:
    name: üöÄ Deploy Full Stack para VPS
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4

    - name: üîë Setup SSH Tools
      run: |
        echo "üîë Instalando ferramentas SSH..."
        sudo apt-get update -q
        sudo apt-get install -y sshpass
        echo "‚úÖ Ferramentas SSH instaladas"

    - name: üîê Validate Secrets
      run: |
        echo "üîê Validando secrets obrigat√≥rios..."

        # Validar VPS_PASSWORD (obrigat√≥rio)
        if [ -z "${{ secrets.VPS_PASSWORD }}" ]; then
          echo "‚ùå ERRO: VPS_PASSWORD n√£o configurado!"
          echo "Configure em: Settings > Secrets and variables > Actions"
          exit 1
        fi
        echo "‚úÖ VPS_PASSWORD configurado"

        # DATABASE_URL √© opcional (pode ser configurado direto na VPS)
        if [ -n "${{ secrets.DATABASE_URL }}" ]; then
          echo "‚úÖ DATABASE_URL configurado (ser√° usado no build)"
        else
          echo "‚ö†Ô∏è  DATABASE_URL n√£o configurado (use .env na VPS ou configure o secret)"
        fi

        echo "‚úÖ Valida√ß√£o de secrets conclu√≠da!"

    - name: üîç Pre-Deploy Validation
      run: |
        echo "üîç Validando estrutura do projeto FERRACO CRM..."
        echo "üìã Arquitetura: Monorepo (apps/backend + apps/frontend)"
        echo ""
        echo "üì¶ Arquivos Docker essenciais:"
        ls -la Dockerfile docker-compose.vps.yml || { echo "‚ùå Docker files faltando!"; exit 1; }
        ls -la docker/nginx.conf docker/startup.sh || { echo "‚ùå Nginx/startup faltando!"; exit 1; }
        echo ""
        echo "üìã Backend (apps/backend/):"
        ls -la apps/backend/package.json apps/backend/src/ apps/backend/prisma/ || { echo "‚ùå Backend incompleto!"; exit 1; }
        echo ""
        echo "üìã Frontend (apps/frontend/):"
        ls -la apps/frontend/package.json apps/frontend/src/ apps/frontend/vite.config.ts || { echo "‚ùå Frontend incompleto!"; exit 1; }
        echo ""
        echo "‚úÖ Estrutura monorepo validada!"

    - name: üì¶ Prepare Deployment Package
      run: |
        echo "üì¶ Preparando pacote FERRACO CRM FULL STACK..."
        echo "  üì¶ Commit: ${{ github.sha }}"
        echo "  üåø Branch: ${{ github.ref_name }}"
        echo "  üë§ Actor: ${{ github.actor }}"
        echo "  üïê Timestamp: $(date -u)"
        echo ""

        # Criar pacote compacto
        tar --warning=no-file-changed -czf deploy.tar.gz \
          --exclude='.git' \
          --exclude='**/node_modules' \
          --exclude='**/dist' \
          --exclude='**/build' \
          --exclude='*.log' \
          --exclude='coverage' \
          --exclude='.env.local' \
          --exclude='.env' \
          --exclude='**/.DS_Store' \
          --exclude='**/Thumbs.db' \
          . || true

        echo ""
        echo "üìä Tamanho do pacote:"
        ls -lh deploy.tar.gz
        echo "‚úÖ Pacote criado com sucesso!"

    - name: üì§ Upload to VPS
      run: |
        echo "üì§ Enviando pacote para VPS..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' scp \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          -o ConnectTimeout=30 \
          deploy.tar.gz ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/tmp/
        echo "‚úÖ Upload conclu√≠do!"

    - name: üöÄ Deploy on VPS
      run: |
        echo "üöÄ Iniciando deploy na VPS..."

        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          -o ServerAliveInterval=30 \
          -o ServerAliveCountMax=3 \
          -o ConnectTimeout=30 \
          ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << "DEPLOY_SCRIPT"
          set -e

          echo "========================================="
          echo "üöÄ FERRACO CRM - Deploy Full Stack"
          echo "========================================="
          echo "üì¶ Commit: ${{ github.sha }}"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üë§ Actor: ${{ github.actor }}"
          echo "üïê Timestamp: $(date)"
          echo "üéØ Arquitetura: Monorepo - Container √önico"
          echo "üê≥ Porta VPS: ${{ env.APP_PORT }}"
          echo "========================================="
          echo ""

          # Configurar sistema
          echo "üì¶ Atualizando sistema..."
          export DEBIAN_FRONTEND=noninteractive

          # Aguardar locks do apt e atualizar
          echo "Aguardando locks do apt..."
          while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
                fuser /var/lib/apt/lists/lock >/dev/null 2>&1 || \
                fuser /var/lib/dpkg/lock >/dev/null 2>&1; do
            echo "  Apt est√° em uso, aguardando..."
            sleep 3
          done

          echo "Atualizando reposit√≥rios..."
          apt-get update -qq || true

          echo "Instalando depend√™ncias..."
          apt-get install -y curl wget ca-certificates lsb-release psmisc >/dev/null 2>&1 || true

          echo "‚úÖ Sistema atualizado"

          # Instalar/Atualizar Docker
          echo "üê≥ Configurando Docker..."
          if ! command -v docker &> /dev/null; then
            echo "Instalando Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh >/dev/null 2>&1
            rm get-docker.sh
            systemctl start docker
            systemctl enable docker
          fi
          docker --version

          # Verificar Docker Compose v2
          if ! docker compose version &> /dev/null; then
            echo "Instalando Docker Compose v2..."
            apt-get update -qq
            apt-get install -y docker-compose-plugin >/dev/null 2>&1
          fi
          docker compose version

          # Parar containers anteriores (SEM remover volumes - preserva banco de dados!)
          echo "‚èπÔ∏è  Parando containers anteriores..."
          cd ${{ env.APP_DIR }} 2>/dev/null || true
          docker compose -f docker-compose.vps.yml -p ${{ env.COMPOSE_PROJECT }} down --remove-orphans 2>/dev/null || true
          echo "‚úÖ Volumes preservados (banco de dados mantido)"

          # Remover containers se ainda existirem
          docker rm -f ferraco-crm-vps 2>/dev/null || true
          docker rm -f ferraco-postgres 2>/dev/null || true

          # Liberar porta
          echo "üîì Liberando porta ${{ env.APP_PORT }}..."
          fuser -k ${{ env.APP_PORT }}/tcp 2>/dev/null || true
          sleep 2

          # Limpar TUDO do Docker relacionado ao Ferraco (REBUILD COMPLETO ZERO)
          echo "üßπ Limpando COMPLETAMENTE Docker para rebuild zero..."

          # Remover imagens do Ferraco (todas as tags e layers)
          docker images --filter "reference=*ferraco*" -q | xargs -r docker rmi -f 2>/dev/null || true
          docker images | grep ferraco | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true

          # Limpar cache de build (layers intermedi√°rias) - AGRESSIVO
          docker builder prune -a -f 2>/dev/null || true

          # Limpar networks √≥rf√£s
          docker network prune -f 2>/dev/null || true

          # IMPORTANTE: N√ÉO limpar volumes (preserva banco de dados PostgreSQL)
          echo "‚ö†Ô∏è  Preservando volumes do PostgreSQL (banco de dados mantido)"
          # docker volume prune -f 2>/dev/null || true  # DESABILITADO - remove banco!
          # docker system prune -a -f 2>/dev/null || true  # DESABILITADO - remove volumes!

          echo "‚úÖ Limpeza completa finalizada - preservando banco de dados PostgreSQL"

          # Backup e prepara√ß√£o
          if [ -d "${{ env.APP_DIR }}" ]; then
            echo "üíæ Fazendo backup..."
            BACKUP_DIR="${{ env.APP_DIR }}.backup.$(date +%Y%m%d-%H%M%S)"
            mv ${{ env.APP_DIR }} $BACKUP_DIR 2>/dev/null || true
            # Manter apenas √∫ltimos 3 backups
            ls -dt ${{ env.APP_DIR }}.backup.* 2>/dev/null | tail -n +4 | xargs -r rm -rf
          fi

          # Extrair c√≥digo
          echo "üìÅ Extraindo aplica√ß√£o..."
          mkdir -p ${{ env.APP_DIR }}
          cd ${{ env.APP_DIR }}
          tar -xzf /tmp/deploy.tar.gz
          rm -f /tmp/deploy.tar.gz

          # Validar estrutura monorepo
          echo "üîç Validando estrutura monorepo..."
          [ -f "Dockerfile" ] || { echo "‚ùå Dockerfile n√£o encontrado!"; exit 1; }
          [ -f "docker-compose.vps.yml" ] || { echo "‚ùå docker-compose.vps.yml n√£o encontrado!"; exit 1; }
          [ -d "docker" ] || { echo "‚ùå Pasta docker/ n√£o encontrada!"; exit 1; }
          [ -f "docker/startup.sh" ] || { echo "‚ùå docker/startup.sh n√£o encontrado!"; exit 1; }
          [ -f "docker/nginx.conf" ] || { echo "‚ùå docker/nginx.conf n√£o encontrado!"; exit 1; }
          [ -d "apps/backend" ] || { echo "‚ùå Backend (apps/backend) n√£o encontrado!"; exit 1; }
          [ -d "apps/frontend" ] || { echo "‚ùå Frontend (apps/frontend) n√£o encontrado!"; exit 1; }
          [ -f "apps/backend/package.json" ] || { echo "‚ùå apps/backend/package.json n√£o encontrado!"; exit 1; }
          [ -f "apps/frontend/package.json" ] || { echo "‚ùå apps/frontend/package.json n√£o encontrado!"; exit 1; }
          [ -d "apps/backend/prisma" ] || { echo "‚ùå apps/backend/prisma n√£o encontrado!"; exit 1; }

          # Corrigir permiss√µes dos scripts
          echo "üîß Corrigindo permiss√µes dos scripts..."
          chmod +x docker/startup.sh 2>/dev/null || true

          echo "‚úÖ Estrutura monorepo validada!"

          # Criar diret√≥rios persistentes (volumes Docker usar√£o esses diret√≥rios)
          echo "üóÑÔ∏è  Criando diret√≥rios persistentes para volumes Docker..."
          mkdir -p data/ferraco-data data/ferraco-logs data/ferraco-uploads
          chmod 777 data/ferraco-data data/ferraco-logs data/ferraco-uploads
          echo "‚úÖ Diret√≥rios criados: data/ferraco-data, data/ferraco-logs, data/ferraco-uploads"

          # Configurar vari√°veis de ambiente para Docker
          echo "‚öôÔ∏è  Configurando ambiente Docker..."
          export BUILD_TIMESTAMP=$(date +%s)
          export JWT_SECRET="ferraco-vps-jwt-production-secret-2025"
          export CORS_ORIGIN="https://${{ env.DOMAIN }},http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}"
          export ALLOWED_ORIGINS="https://${{ env.DOMAIN }},http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}"
          export LOG_LEVEL=info
          export NODE_ENV=production

          # DATABASE_URL (do secret ou do .env na VPS)
          if [ -n "${{ secrets.DATABASE_URL }}" ]; then
            export DATABASE_URL="${{ secrets.DATABASE_URL }}"
            echo "‚úÖ Usando DATABASE_URL do GitHub Secret"
          else
            echo "‚ö†Ô∏è  DATABASE_URL n√£o definido - aplica√ß√£o usar√° .env na VPS"
          fi

          # Build da imagem
          echo "üèóÔ∏è  Building imagem Docker (isso pode levar alguns minutos)..."
          if [ -n "${{ secrets.DATABASE_URL }}" ]; then
            DOCKER_BUILDKIT=1 docker compose -f docker-compose.vps.yml -p ${{ env.COMPOSE_PROJECT }} build \
              --no-cache \
              --pull \
              --build-arg BUILD_TIMESTAMP=$BUILD_TIMESTAMP \
              --build-arg DATABASE_URL="${{ secrets.DATABASE_URL }}"
          else
            DOCKER_BUILDKIT=1 docker compose -f docker-compose.vps.yml -p ${{ env.COMPOSE_PROJECT }} build \
              --no-cache \
              --pull \
              --build-arg BUILD_TIMESTAMP=$BUILD_TIMESTAMP
          fi

          # Iniciar aplica√ß√£o
          echo "üöÄ Iniciando aplica√ß√£o..."
          docker compose -f docker-compose.vps.yml -p ${{ env.COMPOSE_PROJECT }} up -d

          # Aguardar container iniciar
          echo "‚è≥ Aguardando container iniciar (30 segundos)..."
          sleep 30

          # Executar migrations da API Externa (novas tabelas)
          echo "üóÑÔ∏è  Aplicando migrations da API Externa..."
          docker exec ferraco-crm-vps sh -c "cd /app/backend && npx prisma migrate deploy" || {
            echo "‚ö†Ô∏è  Migrations falharam, tentando novamente..."
            sleep 5
            docker exec ferraco-crm-vps sh -c "cd /app/backend && npx prisma migrate deploy"
          }

          # Gerar Prisma Client atualizado
          echo "üîÑ Gerando Prisma Client..."
          docker exec ferraco-crm-vps sh -c "cd /app/backend && npx prisma generate"

          # Verificar se novas tabelas foram criadas
          echo "‚úÖ Verificando novas tabelas da API Externa..."
          docker exec ferraco-crm-vps sh -c "cd /app/backend && npx prisma db execute --stdin" <<'SQL'
SELECT table_name FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name IN ('api_keys', 'api_usage_logs', 'webhooks', 'webhook_deliveries', 'event_logs')
ORDER BY table_name;
SQL

          echo "‚úÖ Migrations da API Externa aplicadas com sucesso!"

          # Mostrar logs iniciais
          echo "üìã Logs iniciais do container:"
          docker compose -f docker-compose.vps.yml -p ${{ env.COMPOSE_PROJECT }} logs --tail 30

          # Aguardar servi√ßos internos (Nginx + Backend)
          echo "‚è≥ Aguardando servi√ßos internos (60 segundos)..."
          sleep 60

          # Verificar containers
          echo "üîç Verificando containers..."
          docker compose -f docker-compose.vps.yml -p ${{ env.COMPOSE_PROJECT }} ps

          # Health check - USAR 127.0.0.1 NO ALPINE (localhost n√£o funciona)
          echo "ü©∫ Executando health checks..."
          echo "‚ö†Ô∏è  Usando 127.0.0.1 (Alpine Linux n√£o resolve 'localhost')"
          echo "‚ÑπÔ∏è  Backend serve /health (n√£o /api/health)"

          MAX_TRIES=20
          HEALTH_OK=false

          echo ""
          echo "üîç Health check da aplica√ß√£o..."
          for i in $(seq 1 $MAX_TRIES); do
            if curl -f -s http://127.0.0.1:${{ env.APP_PORT }}/health >/dev/null 2>&1; then
              RESPONSE=$(curl -s http://127.0.0.1:${{ env.APP_PORT }}/health)
              echo "‚úÖ Health check OK!"
              echo "   Response: $RESPONSE"
              HEALTH_OK=true
              break
            fi
            echo "  Tentativa $i/$MAX_TRIES - aguardando..."
            sleep 5
          done

          # Verifica√ß√£o de volumes e permiss√µes
          echo ""
          echo "üîç Verificando volumes e permiss√µes..."
          if [ -d "data/ferraco-uploads" ]; then
            echo "‚úÖ Diret√≥rio uploads existe"
            ls -la data/ferraco-uploads
            UPLOAD_PERM=$(stat -c '%a' data/ferraco-uploads)
            echo "   Permiss√µes: $UPLOAD_PERM"
            if [ "$UPLOAD_PERM" = "777" ]; then
              echo "‚úÖ Permiss√µes corretas (777)"
            else
              echo "‚ö†Ô∏è  Permiss√µes incorretas, corrigindo..."
              chmod 777 data/ferraco-uploads
            fi
          else
            echo "‚ùå Diret√≥rio uploads n√£o existe!"
          fi

          # Verificar montagem de volumes no container
          echo ""
          echo "üîç Verificando montagem de volumes no container..."
          docker exec ferraco-crm-vps ls -la /app/uploads 2>/dev/null || echo "‚ö†Ô∏è  Diret√≥rio /app/uploads n√£o acess√≠vel"
          docker exec ferraco-crm-vps touch /app/uploads/.test 2>/dev/null && \
            echo "‚úÖ Volume /app/uploads com permiss√£o de escrita" || \
            echo "‚ùå Volume /app/uploads SEM permiss√£o de escrita"
          docker exec ferraco-crm-vps rm -f /app/uploads/.test 2>/dev/null || true

          # Verificar configura√ß√£o do Express para servir arquivos est√°ticos
          echo ""
          echo "üîç Verificando configura√ß√£o do Express..."
          docker exec ferraco-crm-vps grep -r "express.static" /app/backend/dist/ 2>/dev/null | head -n 1 && \
            echo "‚úÖ Express configurado para servir arquivos est√°ticos" || \
            echo "‚ö†Ô∏è  Express pode n√£o estar configurado corretamente"

          # Verifica√ß√£o final
          echo ""
          echo "========================================="
          if [ "$HEALTH_OK" = true ]; then
            echo "‚úÖ DEPLOY CONCLU√çDO COM SUCESSO!"
          else
            echo "‚ùå FALHA NO DEPLOY - Health check n√£o passou!"
          fi
          echo "========================================="

          # Validar container Docker
          echo ""
          echo "üîç Validando container Docker..."
          CONTAINER_COUNT=$(docker ps --filter "name=ferraco-crm-vps" --format "{{.Names}}" | wc -l)
          if [ "$CONTAINER_COUNT" -eq "1" ]; then
            echo "‚úÖ Container ferraco-crm-vps rodando"

            # Mostrar informa√ß√µes do container
            echo ""
            echo "üì¶ Status do Container:"
            docker ps --filter "name=ferraco-crm-vps" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

            # Mostrar logs completos se health check falhou
            if [ "$HEALTH_OK" != true ]; then
              echo ""
              echo "üìã Logs completos do container (√∫ltimas 100 linhas):"
              docker compose -f docker-compose.vps.yml -p ${{ env.COMPOSE_PROJECT }} logs --tail 100
            fi
          else
            echo "‚ùå ERRO: Container n√£o encontrado ou m√∫ltiplos containers!"
            echo "Containers ativos:"
            docker ps
          fi

          # Verificar processos PM2 (n√£o deveria ter)
          if command -v pm2 &> /dev/null; then
            PM2_COUNT=$(pm2 list 2>/dev/null | grep -c "ferraco" || true)
            if [ "$PM2_COUNT" -eq "0" ]; then
              echo "‚úÖ Nenhum processo PM2 do Ferraco (isolamento correto)"
            else
              echo "‚ö†Ô∏è  AVISO: Existem $PM2_COUNT processos PM2 do Ferraco"
              echo "   Isso pode interferir com o Docker!"
              pm2 list
            fi
          fi

          echo ""
          echo "üîó Links de Acesso:"
          echo "  üåê Aplica√ß√£o: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}"
          echo "  üîå Backend API: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/api"
          echo "  ü©∫ Health: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/health"
          echo "  üë®‚Äçüíº Admin: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/admin"
          echo "========================================="

          # Falhar se health check n√£o passou
          if [ "$HEALTH_OK" != true ]; then
            echo ""
            echo "‚ùå Deploy falhou - health check n√£o passou!"
            exit 1
          fi
        DEPLOY_SCRIPT

    - name: ‚úÖ Post-Deploy Verification
      run: |
        echo ""
        echo "========================================="
        echo "‚úÖ VERIFICA√á√ÉO P√ìS-DEPLOY"
        echo "========================================="

        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << "VERIFY_SCRIPT"
          set -e
          cd ${{ env.APP_DIR }}

          echo ""
          echo "üîç 1. Verificando Containers Docker..."
          docker ps --filter "name=ferraco" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

          echo ""
          echo "üîç 2. Verificando Volumes..."
          echo "   üìÅ data/ferraco-data:"
          ls -lah data/ferraco-data | head -5
          echo "   üìÅ data/ferraco-logs:"
          ls -lah data/ferraco-logs | head -5
          echo "   üìÅ data/ferraco-uploads:"
          ls -lah data/ferraco-uploads | head -5

          echo ""
          echo "üîç 3. Verificando Permiss√µes..."
          stat -c "   %n: %a (%A)" data/ferraco-data
          stat -c "   %n: %a (%A)" data/ferraco-logs
          stat -c "   %n: %a (%A)" data/ferraco-uploads

          echo ""
          echo "üîç 4. Verificando Montagem no Container..."
          echo "   /app/uploads:"
          docker exec ferraco-crm-vps ls -lah /app/uploads | head -5 || echo "   ‚ùå Erro ao acessar /app/uploads"

          echo ""
          echo "üîç 5. Testando Escrita no Volume..."
          docker exec ferraco-crm-vps sh -c "echo 'test' > /app/uploads/.deploy-test && rm /app/uploads/.deploy-test" && \
            echo "   ‚úÖ Volume /app/uploads com escrita OK" || \
            echo "   ‚ùå Volume /app/uploads SEM permiss√£o de escrita"

          echo ""
          echo "üîç 6. Verificando Endpoints..."
          echo "   /health:"
          curl -s http://127.0.0.1:${{ env.APP_PORT }}/health | head -c 100 && echo "" || echo "   ‚ùå Erro"
          echo "   /api/landing-page/config:"
          curl -s http://127.0.0.1:${{ env.APP_PORT }}/api/landing-page/config | head -c 150 && echo "..." || echo "   ‚ùå Erro"

          echo ""
          echo "üîç 7. Verificando API Externa (Swagger)..."
          echo "   /api-docs (Swagger UI):"
          curl -s -o /dev/null -w "   Status: %{http_code}\n" http://127.0.0.1:${{ env.APP_PORT }}/api-docs
          echo "   /api/openapi.json (OpenAPI Spec):"
          curl -s http://127.0.0.1:${{ env.APP_PORT }}/api/openapi.json | head -c 100 && echo "..." || echo "   ‚ùå Erro"

          echo ""
          echo "üîç 8. Verificando Tabelas da API Externa no Banco..."
          docker exec ferraco-crm-vps sh -c "cd /app/backend && npx prisma db execute --stdin" <<'SQL' || echo "   ‚ö†Ô∏è  N√£o foi poss√≠vel verificar"
SELECT
  CASE
    WHEN COUNT(*) = 5 THEN '‚úÖ Todas as 5 tabelas da API Externa existem'
    ELSE '‚ùå Faltam tabelas: ' || (5 - COUNT(*))::text
  END as status
FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name IN ('api_keys', 'api_usage_logs', 'webhooks', 'webhook_deliveries', 'event_logs');
SQL

          echo ""
          echo "üîç 9. Verificando Logs do Container (√∫ltimas 20 linhas)..."
          docker logs ferraco-crm-vps --tail 20

          echo ""
          echo "========================================="
          echo "‚úÖ VERIFICA√á√ÉO CONCLU√çDA"
          echo "========================================="
        VERIFY_SCRIPT

    - name: üéâ Deploy Success
      run: |
        echo ""
        echo "========================================="
        echo "üéâ FERRACO CRM DEPLOYADO COM SUCESSO!"
        echo "========================================="
        echo ""
        echo "üì¶ Informa√ß√µes do Deploy:"
        echo "  üè∑Ô∏è  Vers√£o: 2.0.0"
        echo "  üì¶ Commit: ${{ github.sha }}"
        echo "  üåø Branch: ${{ github.ref_name }}"
        echo "  üë§ Autor: ${{ github.actor }}"
        echo "  üïê Data: $(date)"
        echo ""
        echo "üîó Links de Acesso:"
        echo "  üåê Aplica√ß√£o: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}"
        echo "  üîå API: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/api"
        echo "  ü©∫ Health: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/health"
        echo "  üë®‚Äçüíº Admin: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/admin"
        echo ""
        echo "üÜï API Externa v1.0:"
        echo "  üìö Documenta√ß√£o Swagger: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/api-docs"
        echo "  üìÑ OpenAPI Spec: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/api/openapi.json"
        echo "  üîë API Keys: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/api/api-keys"
        echo "  üåê Leads External: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/api/v1/external/leads"
        echo "  üîî Webhooks: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/api/v1/external/webhooks"
        echo "  üì¶ Batch Ops: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/api/v1/external/batch"
        echo ""
        echo "üèóÔ∏è  Stack Tecnol√≥gica:"
        echo "  üéØ Backend: Node.js + Express + Prisma + PostgreSQL"
        echo "  üé® Frontend: React + Vite + TypeScript + Tailwind"
        echo "  üåê Proxy: Nginx (Alpine Linux)"
        echo "  üê≥ Deploy: Docker (Container √önico - Monorepo)"
        echo "  üîê Auth: JWT + Bcrypt + API Keys"
        echo "  üÜï API Externa: Swagger/OpenAPI 3.0 + Webhooks + Batch Ops"
        echo ""
        echo "üìå Notas Importantes:"
        echo "  ‚Ä¢ Arquitetura: Monorepo (apps/backend + apps/frontend)"
        echo "  ‚Ä¢ Health checks usam 127.0.0.1 (Alpine n√£o resolve localhost)"
        echo "  ‚Ä¢ Container isolado - sem PM2 no host"
        echo "  ‚Ä¢ Build completo com --no-cache"
        echo "  ‚Ä¢ Volumes persistentes: data, logs, uploads"
        echo "  ‚Ä¢ Permiss√µes: 777 em todos os volumes"
        echo ""
        echo "‚úÖ Sistema pronto para uso!"
        echo "========================================="
