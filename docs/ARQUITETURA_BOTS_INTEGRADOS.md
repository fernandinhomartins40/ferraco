# Arquitetura de Integra√ß√£o Inteligente dos Chatbots

## üìã Vis√£o Geral

Sistema integrado de dois chatbots que trabalham em sinergia:

1. **Chatbot Web (/chat)**: Capta√ß√£o inicial de leads
2. **Bot WhatsApp**: Continua√ß√£o inteligente via WhatsApp + Automa√ß√µes Kanban

## üèóÔ∏è Arquitetura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        CHATBOT WEB (/chat)                          ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ  1. Usu√°rio acessa /chat                                           ‚îÇ
‚îÇ  2. Conversa com bot web                                           ‚îÇ
‚îÇ  3. Captura: nome, telefone, interesse em produtos                ‚îÇ
‚îÇ  4. Op√ß√µes finais:                                                 ‚îÇ
‚îÇ     ‚úÖ "Falar com a equipe"                                        ‚îÇ
‚îÇ     ‚úÖ "Quero or√ßamento"                                           ‚îÇ
‚îÇ     ‚úÖ "Ver produtos"                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    LEAD CRIADO NO BANCO                             ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ  ‚Ä¢ status: "NOVO"                                                  ‚îÇ
‚îÇ  ‚Ä¢ priority: HIGH/MEDIUM/LOW (baseado em score)                   ‚îÇ
‚îÇ  ‚Ä¢ metadata:                                                       ‚îÇ
‚îÇ    - selectedProducts: ["Bebedouro", "Freestall"]                 ‚îÇ
‚îÇ    - wantsHumanContact: true                                      ‚îÇ
‚îÇ    - wantsPricing: true                                           ‚îÇ
‚îÇ    - interest: "Bebedouro e Freestall"                           ‚îÇ
‚îÇ    - userResponses: {...}                                         ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ  ‚Ä¢ Tags autom√°ticas adicionadas:                                  ‚îÇ
‚îÇ    #interesse-bebedouro                                            ‚îÇ
‚îÇ    #interesse-freestall                                            ‚îÇ
‚îÇ    #quer-orcamento                                                 ‚îÇ
‚îÇ    #handoff-humano                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  SISTEMA DE DECIS√ÉO INTELIGENTE                     ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ  IF (wantsHumanContact || wantsPricing) {                         ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                        ‚îÇ
‚îÇ    ‚îÇ   TRIGGER BOT WHATSAPP              ‚îÇ                        ‚îÇ
‚îÇ    ‚îÇ   ‚Ä¢ Enviar mensagem inicial         ‚îÇ                        ‚îÇ
‚îÇ    ‚îÇ   ‚Ä¢ Enviar materiais dos produtos   ‚îÇ                        ‚îÇ
‚îÇ    ‚îÇ   ‚Ä¢ Responder d√∫vidas (FAQ)         ‚îÇ                        ‚îÇ
‚îÇ    ‚îÇ   ‚Ä¢ SEMPRE: handoff para humano     ‚îÇ                        ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                        ‚îÇ
‚îÇ  }                                                                 ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ  IF (lead.status === "NOVO") {                                    ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                        ‚îÇ
‚îÇ    ‚îÇ   ADICIONAR AO KANBAN AUTOMA√á√ÉO     ‚îÇ                        ‚îÇ
‚îÇ    ‚îÇ   ‚Ä¢ Lead entra na coluna "Lead Novo"‚îÇ                        ‚îÇ
‚îÇ    ‚îÇ   ‚Ä¢ Aguarda movimenta√ß√£o manual     ‚îÇ                        ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                        ‚îÇ
‚îÇ  }                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ                         ‚îÇ
          ‚ñº                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   BOT WHATSAPP       ‚îÇ  ‚îÇ   AUTOMA√á√ïES KANBAN          ‚îÇ
‚îÇ                      ‚îÇ  ‚îÇ                              ‚îÇ
‚îÇ  ‚Ä¢ Sess√£o criada     ‚îÇ  ‚îÇ  ‚Ä¢ Lead na coluna "Lead Novo"‚îÇ
‚îÇ  ‚Ä¢ contextData:      ‚îÇ  ‚îÇ  ‚Ä¢ Movimenta√ß√£o manual:      ‚îÇ
‚îÇ    - interesse       ‚îÇ  ‚îÇ    - Negocia√ß√£o              ‚îÇ
‚îÇ    - produtos        ‚îÇ  ‚îÇ    - Or√ßamento Enviado       ‚îÇ
‚îÇ    - leadName        ‚îÇ  ‚îÇ    - Venda Conclu√≠da         ‚îÇ
‚îÇ                      ‚îÇ  ‚îÇ                              ‚îÇ
‚îÇ  Fluxo:              ‚îÇ  ‚îÇ  Cada coluna:                ‚îÇ
‚îÇ  1. Sauda√ß√£o         ‚îÇ  ‚îÇ  ‚Ä¢ Template de mensagem      ‚îÇ
‚îÇ  2. Envio materiais  ‚îÇ  ‚îÇ  ‚Ä¢ Intervalo de envio        ‚îÇ
‚îÇ  3. Responder d√∫vidas‚îÇ  ‚îÇ  ‚Ä¢ Produtos vinculados       ‚îÇ
‚îÇ  4. Handoff humano   ‚îÇ  ‚îÇ  ‚Ä¢ Agendamento (opcional)    ‚îÇ
‚îÇ                      ‚îÇ  ‚îÇ                              ‚îÇ
‚îÇ  ‚ö†Ô∏è N√ÉO interfere    ‚îÇ  ‚îÇ  ‚ö†Ô∏è N√ÉO interfere            ‚îÇ
‚îÇ     com Kanban       ‚îÇ  ‚îÇ     com Bot WhatsApp         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîÑ Fluxo Detalhado

### 1. Capta√ß√£o no Chat Web

#### Fluxo Inteligente de Sele√ß√£o de Produtos

Quando o usu√°rio clica em um produto, o bot **N√ÉO** exibe mais a mensagem "Desculpe, n√£o entendi". Em vez disso:

1. **Mensagem Inteligente**: Informa que a equipe ser√° contatada para enviar informa√ß√µes
2. **Lista de Produtos Selecionados**: Mostra todos os produtos j√° escolhidos
3. **Op√ß√£o de Adicionar Mais**: Permite selecionar produtos adicionais
4. **Integra√ß√£o com Tags**: Todos os produtos s√£o automaticamente taggeados no lead

```typescript
// Exemplo de sess√£o ap√≥s sele√ß√£o de m√∫ltiplos produtos
chatbotSession = {
  capturedName: "Jo√£o Silva",
  capturedPhone: "45999070479",
  capturedEmail: "joao@example.com",
  interest: "Bebedouro e Freestall",
  userResponses: {
    selected_product: "üì¶ Freestall", // √öltimo produto selecionado
    selected_products: ["üì¶ Bebedouro", "üì¶ Freestall"], // Array acumulado
    wants_pricing: false, // N√£o pediu or√ßamento direto
    wants_human: false, // N√£o pediu handoff ainda
    user_type: "üêÑ Sim, sou produtor rural",
    activity: "ü•õ Pecu√°ria leiteira"
  },
  qualificationScore: 85,
  currentStepId: "product_interest" // Step intermedi√°rio inteligente
}
```

#### Steps do Fluxo de Produto

**Step `show_products`**: Exibe lista de produtos com op√ß√µes din√¢micas
- Cada produto √© uma op√ß√£o clic√°vel
- `nextStepId: 'product_interest'` para todos os produtos

**Step `product_interest` (NOVO)**: Intermedi√°rio inteligente
- Mensagem: "Vou solicitar √† nossa equipe que entre em contato..."
- Mostra lista de produtos j√° selecionados: `{selectedProductsList}`
- Op√ß√µes:
  - ‚úÖ "Sim, quero ver mais produtos" ‚Üí volta para `show_products`
  - üí¨ "N√£o, pode prosseguir" ‚Üí vai para `product_interest_confirm`
  - üë§ "Falar com a equipe agora" ‚Üí vai para `human_handoff`

**Step `product_interest_confirm` (NOVO)**: Confirma√ß√£o final
- Mensagem: "Nossa equipe vai entrar em contato em breve..."
- Op√ß√µes de marketing opt-in
- **A√ß√µes**: `create_lead` + `send_notification`

```typescript
// Exemplo de userResponses ap√≥s m√∫ltiplas sele√ß√µes
userResponses = {
  selected_product: "üì¶ Freestall", // √öltimo
  selected_products: ["üì¶ Bebedouro", "üì¶ Freestall", "üì¶ Ordenhadeira"], // Acumulado
  explore_more: "‚úÖ Sim, quero ver mais produtos", // Usu√°rio voltou 2x
  marketing_opt_in: "‚úÖ Pode avisar sim"
}
```

### 2. Cria√ß√£o do Lead com Metadata Enriquecida

```typescript
lead = {
  id: "abc123",
  name: "Jo√£o Silva",
  phone: "45999070479",
  status: "NOVO",
  priority: "HIGH", // Score >= 60
  source: "Chatbot",
  leadScore: 85,
  metadata: {
    // Produtos de interesse
    selectedProducts: ["Bebedouro", "Freestall"],
    productsCount: 2,

    // Inten√ß√µes
    wantsHumanContact: true,
    wantsPricing: true,
    wantsMaterial: false,

    // Contexto da conversa
    sessionId: "session123",
    interest: "Bebedouro e Freestall",
    segment: "Pecu√°ria leiteira",
    userType: "produtor_rural",
    activity: "Pecu√°ria leiteira",

    // Triggers para automa√ß√£o
    shouldTriggerWhatsAppBot: true,
    shouldAddToKanbanAutomation: true,

    // Timestamps
    capturedAt: "2025-10-21T14:30:00Z",
    conversationStage: 7
  }
}
```

### 3. Sistema de Tags Autom√°ticas

#### L√≥gica de M√∫ltiplos Produtos

O sistema agora acumula produtos selecionados em um array e cria tags para **todos** os produtos:

```typescript
// chatbot-session.service.ts - Captura de produtos
if (selectedOption.captureAs === 'selected_product') {
  // Inicializar array se n√£o existir
  if (!userResponses.selected_products) {
    userResponses.selected_products = [];
  }

  // Adicionar produto se ainda n√£o estiver na lista
  if (!userResponses.selected_products.includes(selectedOption.label)) {
    userResponses.selected_products.push(selectedOption.label);
  }
}

// lead-tagging.service.ts - Cria√ß√£o de tags
// 1. Produto √∫nico (compatibilidade)
if (userResponses.selected_product) {
  tags.push(`interesse-${slugify(productName)}`);
}

// 2. M√∫ltiplos produtos (NOVO)
if (userResponses.selected_products && Array.isArray(userResponses.selected_products)) {
  userResponses.selected_products.forEach((product: string) => {
    tags.push(`interesse-${slugify(product)}`);
  });
}
```

#### Tags Criadas Automaticamente

```typescript
// Exemplo com 3 produtos selecionados
tags = [
  { name: "interesse-bebedouro", color: "#3B82F6" },
  { name: "interesse-freestall", color: "#3B82F6" },
  { name: "interesse-ordenhadeira", color: "#3B82F6" },
  { name: "score-alto", color: "#34D399" }, // Score >= 60
  { name: "produtor-rural", color: "#6B7280" },
  { name: "pecuaria-leiteira", color: "#6B7280" }
]

// Vincula√ß√£o autom√°tica
leadTags = [
  { leadId: "abc123", tagId: "tag1" }, // interesse-bebedouro
  { leadId: "abc123", tagId: "tag2" }, // interesse-freestall
  { leadId: "abc123", tagId: "tag3" }, // interesse-ordenhadeira
  { leadId: "abc123", tagId: "tag4" }, // score-alto
  { leadId: "abc123", tagId: "tag5" }, // produtor-rural
  { leadId: "abc123", tagId: "tag6" }  // pecuaria-leiteira
]
```

#### Extra√ß√£o de Produtos para Metadata

```typescript
// lead-tagging.service.ts
extractSelectedProducts(userResponses: any): string[] {
  const products: string[] = [];

  // Produto √∫nico
  if (userResponses.selected_product) {
    const product = this.extractProductName(userResponses.selected_product);
    if (product) products.push(product);
  }

  // M√∫ltiplos produtos (sem duplicatas)
  if (userResponses.selected_products && Array.isArray(userResponses.selected_products)) {
    userResponses.selected_products.forEach((product: string) => {
      const cleaned = this.extractProductName(product); // Remove emojis
      if (cleaned && !products.includes(cleaned)) {
        products.push(cleaned);
      }
    });
  }

  return products; // ["Bebedouro", "Freestall", "Ordenhadeira"]
}
```

### 4. Trigger do Bot WhatsApp

```typescript
// Condi√ß√µes para trigger
if (metadata.wantsHumanContact || metadata.wantsPricing) {
  await whatsappBotService.startBotConversation(lead.id);
}

// Bot WhatsApp Session criada
whatsappBotSession = {
  id: "bot-session-123",
  leadId: "abc123",
  phone: "45999070479",
  currentStepId: "initial_context",
  contextData: {
    leadName: "Jo√£o Silva",
    interesse: "Bebedouro e Freestall",
    selectedProducts: ["Bebedouro", "Freestall"],
    companyName: "Ferraco Metal√∫rgica",
    companyPhone: "(45) 99907-0479",
    // ... config da empresa
  },
  isActive: true,
  handedOffToHuman: false
}
```

### 5. Fluxo do Bot WhatsApp

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Step 1: initial_context                                    ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ üì± "Ol√°, Jo√£o! Aqui √© o assistente da Ferraco!            ‚îÇ
‚îÇ     Vi que voc√™ estava conversando comigo no site h√° pouco ‚îÇ
‚îÇ     e demonstrou interesse em Bebedouro e Freestall.       ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ     Posso te enviar mais informa√ß√µes e materiais?"         ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  [‚úÖ Sim, pode enviar!]  [üìÖ Pode, mas s√≥ amanh√£]         ‚îÇ
‚îÇ  [‚ùå N√£o, obrigado]                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                          ‚ñº (usu√°rio clica "Sim")
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Step 2: send_materials                                     ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ üì± "Perfeito! Vou te mandar tudo agora. üì±"               ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ [Enviando automaticamente]                                 ‚îÇ
‚îÇ  üìÑ Catalogo_Bebedouro.pdf                                ‚îÇ
‚îÇ  üìÑ Catalogo_Freestall.pdf                                ‚îÇ
‚îÇ  üñºÔ∏è Foto_Bebedouro_1.jpg                                  ‚îÇ
‚îÇ  üñºÔ∏è Foto_Freestall_1.jpg                                  ‚îÇ
‚îÇ  üí∞ Tabela_Precos_2025.pdf                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                          ‚ñº (autom√°tico)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Step 3: after_materials                                    ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ üì± "Pronto! Enviei todo o material. üì¶                     ‚îÇ
‚îÇ     D√° uma olhada e me conta: o que achou?"               ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  [üí¨ Tenho uma d√∫vida]  [üí∞ Quero falar sobre pre√ßos]     ‚îÇ
‚îÇ  [üìç Onde fica a loja?]  [‚úÖ Tudo claro, quero comprar]   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                          ‚ñº (eventualmente)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Step Final: handoff_to_sales                               ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ üì± "Perfeito, Jo√£o! üéâ                                     ‚îÇ
‚îÇ     Vou te conectar com nosso especialista agora.          ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ     O Fernando vai te atender em instantes via WhatsApp.   ‚îÇ
‚îÇ     Ele vai tirar todas as suas d√∫vidas e ajudar com o     ‚îÇ
‚îÇ     or√ßamento! üë®‚Äçüíº"                                        ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ [Sess√£o marcada como handedOffToHuman: true]              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 6. Automa√ß√µes Kanban (Paralelo)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ COLUNA: Lead Novo (status: NOVO)                          ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  üìã Jo√£o Silva                                            ‚îÇ
‚îÇ      #interesse-bebedouro #interesse-freestall            ‚îÇ
‚îÇ      #quer-orcamento #handoff-humano                      ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  [Aguardando movimenta√ß√£o manual do usu√°rio]              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚îÇ (Usu√°rio arrasta para "Negocia√ß√£o")
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ COLUNA: Negocia√ß√£o (status: NEGOCIACAO)                   ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  Template configurado:                                     ‚îÇ
‚îÇ  "Ol√° {{nome}}! Vi que est√° interessado em {{produtos}}. ‚îÇ
‚îÇ   Podemos agendar uma visita t√©cnica?"                    ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  Intervalo: 60s entre mensagens                           ‚îÇ
‚îÇ  Produtos vinculados: Bebedouro, Freestall               ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  ‚è∞ Pr√≥ximo envio: Hoje √†s 15:00                          ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  [AUTOMA√á√ÉO ATIVA]                                        ‚îÇ
‚îÇ  ‚úÖ Mensagem ser√° enviada automaticamente                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üéØ Intelig√™ncia e Sincroniza√ß√£o

### Preven√ß√£o de Conflitos

1. **Bot WhatsApp vs Automa√ß√£o Kanban**
   - Bot WhatsApp: Ativo apenas se `handedOffToHuman: false`
   - Automa√ß√£o Kanban: Verifica se `whatsappBotSession.isActive: false`
   - Quando bot faz handoff, automa√ß√µes podem assumir

2. **Prioridade de Envio**
   ```typescript
   if (whatsappBotSession?.isActive && !whatsappBotSession?.handedOffToHuman) {
     // Bot WhatsApp est√° ativo - N√ÉO enviar automa√ß√£o
     return;
   }

   if (automationLeadPosition?.nextScheduledAt <= now) {
     // Automa√ß√£o deve enviar
     await sendAutomationMessage(lead, template);
   }
   ```

3. **Transi√ß√£o Suave**
   ```typescript
   // Quando bot faz handoff
   await whatsappBotSession.update({
     handedOffToHuman: true,
     handoffAt: new Date()
   });

   // Automa√ß√µes podem assumir ap√≥s 5 minutos
   const canAutomationTakeover =
     Date.now() - handoffAt.getTime() > 5 * 60 * 1000;
   ```

## üìä Monitoramento e Logs

```typescript
// Log completo do ciclo de vida
logger.info('üìù Lead criado', {
  leadId,
  source: 'Chatbot',
  selectedProducts: metadata.selectedProducts,
  triggers: {
    whatsappBot: metadata.shouldTriggerWhatsAppBot,
    kanbanAutomation: metadata.shouldAddToKanbanAutomation
  }
});

logger.info('ü§ñ Bot WhatsApp iniciado', {
  leadId,
  sessionId: whatsappBotSession.id,
  currentStep: 'initial_context'
});

logger.info('üì§ Mensagem automa√ß√£o enviada', {
  leadId,
  columnId,
  templateId,
  scheduledAt,
  sentAt: new Date()
});
```

## üîß Configura√ß√µes

### chatbot-session.service.ts
- Criar lead com metadata enriquecida
- Adicionar tags autom√°ticas
- Trigger condicional do bot WhatsApp

### whatsapp-bot.service.ts
- Receber produtos de interesse
- Enviar materiais dinamicamente
- Sempre fazer handoff para humano

### automation-kanban.service.ts
- Verificar bot ativo antes de enviar
- Respeitar hor√°rios comerciais
- Limitar envios por hora/dia

## ‚úÖ Benef√≠cios

1. **Capta√ß√£o Inteligente**: Chat web captura inten√ß√µes claras
2. **Followup Autom√°tico**: Bot WhatsApp engaja imediatamente
3. **Nutri√ß√£o Cont√≠nua**: Automa√ß√µes Kanban mant√©m engajamento
4. **Handoff Perfeito**: Transi√ß√£o suave para atendimento humano
5. **Zero Conflitos**: Sistemas trabalham em harmonia
6. **Rastreabilidade Total**: Tags e metadata permitem an√°lise profunda
